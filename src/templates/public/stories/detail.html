{% extends "bases/public_base.html" %}

{% block title %}{{ story.title }} - God Stories{% endblock %}

{% block main %}
<article class="content-detail story-detail">
    <div class="container-narrow">
        <header class="article-header">
            <div class="story-badge-large">God Story</div>
            <h1>{{ story.title }}</h1>
            <div class="article-meta">
                <span class="author">
                    <i class="fas fa-user"></i>
                    Shared by {{ story.author_name or story.author.username }}
                </span>
                <span class="date">
                    <i class="fas fa-calendar"></i>
                    {{ story.created_at.strftime('%B %d, %Y') }}
                </span>
                {% if story.category %}
                <span class="category">
                    <i class="fas fa-tag"></i>
                    {{ story.category.title() }}
                </span>
                {% endif %}
            </div>
        </header>

        {% if story.has_image() %}
        <div class="featured-image">
            <img src="data:image/jpeg;base64,{{ story.get_base64_image_data() }}" 
                 alt="{{ story.title }}" class="story-image">
        </div>
        {% endif %}

        <div class="article-content story-content">
            {{ story.content | nl2br | safe }}
        </div>

        {% if story.has_audio() or story.has_video() %}
        <div class="multimedia-section">
            <h3>Multimedia Content</h3>
            
            {% if story.has_audio() %}
            <div class="audio-content">
                <h4><i class="fas fa-volume-up"></i> Audio Testimony</h4>
                <audio controls preload="metadata" class="story-audio">
                    <source src="{{ url_for('main.serve_story_audio', story_id=story.id) }}" type="audio/mp4">
                    <source src="{{ url_for('main.serve_story_audio', story_id=story.id) }}" type="audio/mpeg">
                    <source src="{{ url_for('main.serve_story_audio', story_id=story.id) }}" type="audio/wav">
                    <source src="{{ url_for('main.serve_story_audio', story_id=story.id) }}" type="audio/ogg">
                    <p>Your browser doesn't support HTML5 audio. Here is a <a href="{{ url_for('main.serve_story_audio', story_id=story.id) }}">link to the audio</a> instead.</p>
                </audio>
            </div>
            {% endif %}

            {% if story.has_video() %}
            <div class="video-content">
                <h4><i class="fas fa-video"></i> Video Testimony</h4>
                <div class="video-info">
                    <p><i class="fas fa-info-circle"></i> <strong>Note:</strong> If you can't hear audio, the video may have been uploaded without sound. Please check your device volume or contact us if you expected audio content.</p>
                </div>
                <video controls preload="metadata" class="story-video" controlslist="nodownload">
                    <source src="{{ url_for('main.serve_story_video', story_id=story.id) }}" type="video/mp4">
                    <source src="{{ url_for('main.serve_story_video', story_id=story.id) }}" type="video/webm">
                    <p>Your browser doesn't support HTML5 video. Here is a <a href="{{ url_for('main.serve_story_video', story_id=story.id) }}">link to the video</a> instead.</p>
                </video>
            </div>
            {% endif %}
        </div>
        {% endif %}

        {% if story.tags %}
        <div class="tags-section">
            <h4>Tags</h4>
            <div class="tag-list">
                {% for tag in story.tags.split(',') %}
                <span class="tag">{{ tag.strip() }}</span>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <footer class="article-footer">
            <div class="story-response">
                <div class="response-prompt">
                    <h4>How has this story impacted you?</h4>
                    <p>If this testimony has encouraged you or if you have a similar experience, we'd love to hear from you.</p>
                    <a href="mailto:response@aplaceforme.com?subject=Response to: {{ story.title | urlencode }}" class="btn btn-outline">Share Your Response</a>
                </div>
            </div>

            <div class="share-section">
                <h4>Share this story</h4>
                <div class="share-buttons">
                    <a href="https://twitter.com/intent/tweet?text=This God story is so encouraging: {{ story.title | urlencode }}&url={{ request.url | urlencode }}" 
                       class="share-btn twitter" target="_blank" rel="noopener">
                        <i class="fab fa-twitter"></i> Twitter
                    </a>
                    <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.url | urlencode }}" 
                       class="share-btn facebook" target="_blank" rel="noopener">
                        <i class="fab fa-facebook-f"></i> Facebook
                    </a>
                    <a href="mailto:?subject=Encouraging God Story: {{ story.title | urlencode }}&body=I thought you might be encouraged by this testimony: {{ request.url | urlencode }}" 
                       class="share-btn email">
                        <i class="fas fa-envelope"></i> Email
                    </a>
                </div>
            </div>

            <div class="navigation-section">
                <a href="{{ url_for('main.god_stories') }}" class="btn btn-outline">‚Üê Back to All Stories</a>
            </div>
        </footer>
    </div>
</article>

<!-- Prayer Section -->
<section class="prayer-section">
    <div class="container">
        <div class="prayer-content">
            <h2>Let's Pray Together</h2>
            <p>If this story has touched your heart, take a moment to thank God for His faithfulness and ask Him to continue working in similar ways in your life and the lives of others.</p>
            <div class="prayer-prompt">
                <p><em>"Thank you, Lord, for your faithfulness and for the way you work in our lives. Help us to see your hand at work and to share our stories with others who need encouragement. Amen."</em></p>
            </div>
        </div>
    </div>
</section>
{% endblock %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const video = document.querySelector('.story-video');
    
    if (video) {
        // Ensure audio is enabled
        video.muted = false;
        video.volume = 1.0;
        
        // Handle video load events
        video.addEventListener('loadstart', function() {
            console.log('Video loading started');
        });
        
        video.addEventListener('canplay', function() {
            console.log('Video can start playing');
        });
        
        video.addEventListener('error', function(e) {
            console.error('Video error:', e);
            const errorDiv = document.createElement('div');
            errorDiv.className = 'video-error';
            errorDiv.innerHTML = `
                <p><i class="fas fa-exclamation-triangle"></i> There was an issue loading this video.</p>
                <p>Please try refreshing the page or contact support if the problem persists.</p>
            `;
            video.parentNode.replaceChild(errorDiv, video);
        });
        
        // Handle play event to ensure audio is unmuted
        video.addEventListener('play', function() {
            video.muted = false;
            console.log('Video playback started');
        });
        
        // Add click handler to unmute if needed
        video.addEventListener('click', function() {
            if (video.muted) {
                video.muted = false;
                console.log('Video unmuted');
            }
        });
    }
});
</script>

<style>
.video-error {
    padding: 2rem;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    text-align: center;
    color: #6c757d;
}

.video-error i {
    color: #ffc107;
    font-size: 1.5rem;
    margin-right: 0.5rem;
}

.video-info {
    background: #e7f3ff;
    border: 1px solid #b3d9ff;
    border-radius: 6px;
    padding: 1rem;
    margin-bottom: 1rem;
    color: #0066cc;
}

.video-info i {
    color: #0066cc;
    margin-right: 0.5rem;
}
</style>
